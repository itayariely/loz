<style>
div.dataTables_wrapper {
        width: 800px;
        margin: 0 auto;
    }
td {
  /*padding-right: 10px;*/
  /*text-align: right;*/
  /*min-width: inherit;*/
  /*padding: 20px;*/
}
</style>
<p id="notice"><%= notice %></p>
<div class="row" dir="rtl">



<a class="btn btn-primary showsort" href="#" id="showsort">סינון סמינרים לפי מעגלים</a>
<div style="display:none;" id="sortdiv">
  <%= form_tag friends_path, :method => 'get' do %>
    <ul class="tree">
      <% @circuls.each do |circul| %>
        <li>
          <% if params[:search] %>
            <% b = eval params[:search].to_s.gsub('"', '') %>
            <% if b.include? circul.id %>
              <%= check_box_tag 'search[]', circul.id, true %>
            <% else %>
              <%= check_box_tag 'search[]', circul.id %>
            <% end %>
          <% else %>
            <%= check_box_tag 'search[]', circul.id %>
          <% end %>

          <%= h circul.name %>
          <% if circul.children.any? %>
            <% @par = "friends" %>
            <%= render circul %>
          <% end %>
        </li>
        <% end %>
      </ul>
    <%= submit_tag "Search", name: nil %>
  <% end %>
</div>

  <h1>תצוגה לפי חודשים</h1>
  <table id="month"  class="table display nowrap" cellspacing="0" width="100%">
    <thead>
      <tr>
        <td>שנה</td>
        <td>ינואר</td>
        <td>פברואר</td>
        <td>מרץ</td>
        <td>אפריל</td>
        <td>מאי</td>
        <td>יוני</td>
        <td>יולי</td>
        <td>אוגוסט</td>
        <td>ספטמבר</td>
        <td>אוקטובר</td>
        <td>נובמבר</td>
        <td>דצמבר</td>

    </tr>
    </thead>
  <tbody>
    <tr>
          <% yearshow =  @events.order(:start_at).first.start_at.year %>
          <% firstline = true %>
          <% monthcount = 1 %>

          <% @events.order(:start_at).each do |event| %>

            <% if yearshow == event.start_at.year %>

              <% if firstline == false %>
                <% while monthcount <= 11 %>
                  </ul></td><td><ul>
                  <% monthcount = monthcount+1 %>
                <% end %>
              </ul></td>
              <% monthcount = 1 %>
              </tr><tr>
            <% end %>

              <td><ul>

                <%= event.start_at.year %>
                <% firstline = false %>
                <% yearshow = yearshow + 1 %>
                <% monthcount == 1 %>
              </td>
              <td>

              <% end %>

              <% while monthcount != event.start_at.month  do %>
                  </ul></td><td><ul>
                  <% monthcount = monthcount+1 %>
              <% end %>

              <% if event.start_at.month == monthcount %>
                <% if params[:search] %>
                  <% a = get_event_circuls(event.circuls) %>
                  <% b = params[:search] %>
                  <% b = eval b.to_s.gsub('"', '') %>
                  <% c = (a & b).empty? %>
                <% end %>
                <li <%= "class='hidden'" if c %> >
                  <%= link_to event.name, event %>
                </li>
            <% end %>
<% if event == @events.last %>
  <% if yearshow != event.start_at.year %>

    <% if firstline == false %>
      <% while monthcount <= 11 %>
        </ul></td><td><ul>
        <% monthcount = monthcount+1 %>
      <% end %>
      </ul></td>
    <% monthcount = 1 %>

  <% end %>
<% end %>
<% end %>

          <% end %>
        </ul>
        </td>
    </tr>
  </tbody>
</table>
</div>
<h1>רשימת חברים</h1>

<table id="friends" class="table datatable">
  <thead>
    <tr>
      <th>שם</th>
      <th>שם משפחה</th>
      <th>טלפון</th>
      <th>דוא"ל"</th>
      <th>תאריך לידה</th>
      <th>חבר/ה המספר מעגלים</th>
      <th>צריך/ה לבוא לסמינרים</th>
      <th>בסך הכל ימים</th>
      <th>בסך הכך לילות</th>
      <th></th>
      <th></th>

    </tr>
  </thead>

  <tbody>
    <% @friends.each do |friend| %>
      <tr>
        <td><%= link_to friend.name, friend %></td>
        <td><%= friend.lname %></td>
        <td><%= friend.phone %></td>
        <td><%= friend.email %></td>
        <td><%= friend.birth_date %></td>
        <td>
          <% a = friend.all_parent_getter if friend.circuls.any? %>
          <%= a.count if friend.circuls.any? %>
        </td>
        <td>
          <% if friend.circuls.any? %>
            <%  events = event_counter(a).count %>
            <% present = (events * 100 / 52) %>
            <div class="progress">
              <div class="progress-bar progress-bar-<%= progress_color(present) %>" style="width: <%= present %>%">
                <%= events %>
              </div>
            </div>
          <% end %>
        </td>
        <td>
          <% if friend.circuls.any? %>
          <%  days = days_counter(a).inject(0, :+) %>
          <%# days += indevidual_evets_counter_days(friend.events).inject(0, :+) %>
          <% present = (days * 100 / 104) %>
          <div class="progress">
            <div class="progress-bar progress-bar-<%= progress_color(present) %>" style="width: <%= present %>%">
              <%= days %>
            </div>
          </div>
            <%# days_counter(a).inject(0, :+) %>
          <% end %>
        </td>
        <td>
          <% if friend.circuls.any? %>
          <%  nights = nights_counter(a).inject(0, :+) %>
          <%# nights += indevidual_evets_counter_nights(friend.events).inject(0, :+) %>
          <% present = (nights * 100 / 52) %>
          <div class="progress">
            <div class="progress-bar progress-bar-<%= progress_color(present) %>" style="width: <%= present %>%">
              <%= nights %>
            </div>
          </div>
            <%# nights_counter(a).inject(0, :+) %>
          <% end %>
        </td>


        <td><%= link_to 'עריכה', edit_friend_path(friend) %></td>
        <td><%= link_to 'מחיקה', friend, method: :delete, data: { confirm: 'למחוק?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'הוספת חבר/ה חדש/ה', new_friend_path %>

<% form_for @friends.first do |f| %>
  <% f.text_area :name, :class => 'ckeditor' %>
  <% f.submit %>
<% end %>
